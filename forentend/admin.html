<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="لوحة التحكم - إدارة مطعم زاد" />
  <meta name="author" content="زاد للمأكولات السورية" />
  <title>لوحة التحكم - زاد</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  
  <!-- Font Awesome -->
  <link href="css/font-awesome.min.css" rel="stylesheet" />
  
  <!-- Custom styles -->
  <link href="css/style.css" rel="stylesheet" />
  
  <!-- Responsive style -->
  <link href="css/responsive.css" rel="stylesheet" />

  <style>
    /* Admin Panel Styles */
    .admin-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Cairo', sans-serif;
      padding-top: 0;
    }
    
    /* Hide the default hero area for admin page */
    .hero_area {
      margin-bottom: 0;
    }

    .admin-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .admin-header {
      background: linear-gradient(135deg, #ffb347 0%, #ff6b35 100%);
      color: white;
      padding: 30px;
      border-radius: 20px 20px 0 0;
      text-align: center;
    }

    .admin-nav {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 0 0 20px 20px;
    }

    .admin-tab {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 25px;
      margin: 5px;
      border-radius: 50px;
      transition: all 0.3s ease;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }
    
    .admin-tab:hover {
      text-decoration: none;
      color: #667eea;
    }

    .admin-tab:hover, .admin-tab.active {
      background: white;
      color: #667eea;
      border-color: white;
      transform: scale(1.05);
    }

    .admin-content {
      padding: 30px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .menu-item {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #ff6b35;
      transition: all 0.3s ease;
    }

    .menu-item:hover {
      transform: translateX(-10px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .price-input {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 12px 15px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
      transition: all 0.3s ease;
    }

    .price-input:focus {
      border-color: #ff6b35;
      box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
      background: white;
    }

    .save-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .save-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .delete-btn {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 9999;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .notification.error {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      width: 100%;
      max-width: 400px;
    }

    .login-input {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 15px 20px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .login-input:focus {
      border-color: #ff6b35;
      box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
      background: white;
    }

    .login-btn {
      background: linear-gradient(135deg, #ff6b35 0%, #ffb347 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }

    .orders-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .order-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-right: 4px solid #28a745;
    }

    .order-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #ffc107;
      color: #212529;
    }

    .status-confirmed {
      background: #28a745;
      color: white;
    }

    .status-delivered {
      background: #17a2b8;
      color: white;
    }

    .status-cancelled {
      background: #dc3545;
      color: white;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .admin-content {
        padding: 15px;
      }
      
      .admin-header {
        padding: 20px 15px;
      }
      
      .menu-item {
        padding: 15px;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  </style>
</head>

<body class="sub_page">
  <div class="hero_area">
    <!-- Header Section -->
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <a class="navbar-brand" href="index.html">
            <span>زاد</span>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
            <span class=""></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="index.html">الرئيسية</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="menu.html">القائمة</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="about.html">من نحن</a>
              </li>
              <li class="nav-item active">
                <a class="nav-link" href="admin.html">لوحة التحكم</a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </header>
  </div>

  <!-- Admin Panel Section -->
  <div class="admin-panel">
    <div class="container-fluid" style="padding: 0 20px;">
      <div class="row justify-content-center">
        <div class="col-12" style="max-width: none;">
          
          <!-- Login Form (Initially Hidden) -->
          <div id="loginForm" class="login-container" style="display: none;">
            <div class="login-card fade-in">
              <h2 class="text-center mb-4" style="color: #495057; font-weight: 700;">
                🔐 تسجيل الدخول
              </h2>
              <p class="text-center text-muted mb-4">أدخل كلمة المرور للوصول إلى لوحة التحكم</p>
              <input type="password" id="passwordInput" class="login-input" placeholder="كلمة المرور" />
              <button onclick="login()" class="login-btn">دخول</button>
              <div class="text-center mt-3">
                <small class="text-muted">⏰ متاح من 6 صباحاً إلى 11 مساءً</small>
              </div>
            </div>
          </div>

          <!-- Admin Dashboard (Initially Hidden) -->
          <div id="adminDashboard" style="display: none;">
            <div class="admin-card fade-in">
              <!-- Header -->
              <div class="admin-header">
                <h1 style="margin: 0; font-size: 2.5rem; font-weight: 700;">
                  🎛️ لوحة التحكم
                </h1>
                <p style="margin: 10px 0 0 0; font-size: 1.1rem; opacity: 0.9;">
                  إدارة القائمة والأسعار والطلبات
                </p>
                <p id="lastUpdate" style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.7;">
                  آخر تحديث: جاري التحميل...
                </p>
                <div class="mt-3">
                  <a href="index.html" class="admin-tab">
                    🏠 الصفحة الرئيسية
                  </a>
                  <button onclick="exportData()" class="admin-tab">
                    📥 تصدير البيانات
                  </button>
                  <button onclick="resetData()" class="admin-tab">
                    🔄 إعادة تعيين
                  </button>
                  <button onclick="logout()" class="admin-tab">
                    🚪 تسجيل خروج
                  </button>
                </div>
              </div>

              <!-- Navigation Tabs -->
              <div class="admin-nav text-center">
                <button onclick="showTab('menu')" id="menuTab" class="admin-tab active">
                  🍽️ القائمة الرئيسية
                </button>
                <button onclick="showTab('offers')" id="offersTab" class="admin-tab">
                  🎉 العروض الخاصة
                </button>
                <button onclick="showTab('orders')" id="ordersTab" class="admin-tab">
                  📋 الطلبات <span id="newOrdersBadge" class="badge badge-danger" style="display: none; margin-left: 5px;">جديد</span>
                </button>
              </div>

              <!-- Content Area -->
              <div class="admin-content" style="max-width: none; padding: 20px 40px;">
                
                <!-- Menu Management -->
                <div id="menuContent" class="tab-content">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 style="color: #495057; margin: 0; font-weight: 600;">
                      📝 إدارة القائمة الرئيسية
                    </h3>
                    <div class="d-flex gap-2">
                      <button onclick="saveAllMenuChanges()" class="save-btn" style="padding: 10px 25px;">
                        💾 حفظ جميع التغييرات
                      </button>
                      <button onclick="syncMenuToWebsite()" class="save-btn" style="background: #17a2b8; padding: 10px 25px;">
                        🔄 مزامنة مع الموقع
                      </button>
                    </div>
                  </div>
                  <div id="menuItems"></div>
                  
                  <!-- Add New Item Form -->
                  <div class="menu-item" style="border: 3px dashed #28a745; background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(32, 201, 151, 0.05) 100%); margin-top: 30px;">
                    <div class="text-center mb-3">
                      <h4 style="color: #28a745; margin-bottom: 10px; font-weight: 700;">
                        ➕ إضافة صنف جديد للقائمة
                      </h4>
                      <p style="color: #6c757d; margin: 0;">املأ البيانات أدناه لإضافة صنف جديد</p>
                    </div>
                    <div class="row align-items-end">
                      <div class="col-lg-3 col-md-6 mb-3">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                          <i class="fa fa-cutlery"></i> اسم الصنف
                        </label>
                        <input type="text" id="newItemName" class="price-input" 
                               style="border: 2px solid #28a745; background: rgba(255,255,255,0.9);" 
                               placeholder="مثل: ورق عنب صغير" />
                      </div>
                      <div class="col-lg-2 col-md-6 mb-3">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                          <i class="fa fa-money"></i> السعر
                        </label>
                        <input type="text" id="newItemPrice" class="price-input" 
                               style="border: 2px solid #28a745; background: rgba(255,255,255,0.9);" 
                               placeholder="150 ج" />
                      </div>
                      <div class="col-lg-5 col-md-8 mb-3">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                          <i class="fa fa-info-circle"></i> وصف الصنف
                        </label>
                        <textarea id="newItemDescription" class="price-input" 
                                  style="border: 2px solid #28a745; background: rgba(255,255,255,0.9); min-height: 45px; resize: vertical;" 
                                  placeholder="وصف مميز للصنف..."></textarea>
                      </div>
                      <div class="col-lg-2 col-md-4 mb-3">
                        <button onclick="addNewItem()" class="save-btn" 
                                style="width: 100%; padding: 12px 20px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                          <i class="fa fa-plus"></i> إضافة الصنف
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Offers Management -->
                <div id="offersContent" class="tab-content" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 style="color: #495057; margin: 0; font-weight: 600;">
                      🎉 إدارة العروض الخاصة
                    </h3>
                    <button onclick="saveAllOffersChanges()" class="save-btn" style="padding: 10px 25px;">
                      💾 حفظ جميع العروض
                    </button>
                  </div>
                  <div id="offersItems"></div>
                  
                  <!-- Add New Offer Form -->
                  <div class="menu-item" style="border-left-color: #ffc107;">
                    <h5 style="color: #ffc107; margin-bottom: 20px;">➕ إضافة عرض جديد</h5>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <input type="text" id="newOfferTitle" class="price-input" placeholder="عنوان العرض" />
                      </div>
                      <div class="col-md-6">
                        <input type="text" id="newOfferDescription" class="price-input" placeholder="وصف العرض" />
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <input type="text" id="newOfferOriginalPrice" class="price-input" placeholder="السعر الأصلي" />
                      </div>
                      <div class="col-md-4">
                        <input type="text" id="newOfferDiscountPrice" class="price-input" placeholder="سعر الخصم" />
                      </div>
                      <div class="col-md-4">
                        <input type="text" id="newOfferDiscount" class="price-input" placeholder="نسبة الخصم" />
                      </div>
                    </div>
                    <button onclick="addNewOffer()" class="save-btn">
                      إضافة العرض
                    </button>
                  </div>
                </div>

                <!-- Orders Management -->
                <div id="ordersContent" class="tab-content" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 style="color: #495057; margin: 0; font-weight: 600;">
                      📋 إدارة الطلبات
                    </h3>
                    <div class="d-flex gap-2 flex-wrap">
                      <button onclick="refreshOrders()" class="save-btn" style="background: #17a2b8; padding: 10px 20px;">
                        🔄 تحديث الطلبات
                      </button>
                      <button onclick="exportOrders()" class="save-btn" style="background: #6f42c1; padding: 10px 20px;">
                        📊 تصدير البيانات
                      </button>
                      <button onclick="addTestOrder()" class="save-btn" style="background: #28a745; padding: 10px 20px;">
                        ➕ محاكاة طلب من العميل
                      </button>
                      <button onclick="window.open('checkout.html', '_blank')" class="save-btn" style="background: #ff6b35; padding: 10px 20px;">
                        🛒 تجربة كعميل
                      </button>
                      <button onclick="debugLocalStorage()" class="save-btn" style="background: #6c757d; padding: 10px 20px;">
                        🔍 فحص البيانات
                      </button>
                    </div>
                  </div>

                  <!-- Order Status Tabs -->
                  <div class="mb-4">
                    <div class="btn-group w-100" role="group">
                      <button type="button" class="btn btn-outline-primary active" id="allOrdersTab" onclick="filterOrders('all')">
                        جميع الطلبات (<span id="allCount">0</span>)
                      </button>
                      <button type="button" class="btn btn-outline-warning" id="pendingOrdersTab" onclick="filterOrders('pending')">
                        جديدة (<span id="pendingCount">0</span>)
                      </button>
                      <button type="button" class="btn btn-outline-success" id="confirmedOrdersTab" onclick="filterOrders('confirmed')">
                        مؤكدة (<span id="confirmedCount">0</span>)
                      </button>
                      <button type="button" class="btn btn-outline-info" id="deliveredOrdersTab" onclick="filterOrders('delivered')">
                        مسلمة (<span id="deliveredCount">0</span>)
                      </button>
                      <button type="button" class="btn btn-outline-danger" id="cancelledOrdersTab" onclick="filterOrders('cancelled')">
                        ملغية (<span id="cancelledCount">0</span>)
                      </button>
                    </div>
                  </div>

                  <!-- Statistics Cards -->
                  <div class="orders-section" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div class="row mb-4">
                      <div class="col-xl-3 col-lg-3 col-md-6 col-6 text-center mb-3">
                        <div style="background: linear-gradient(135deg, #ffc107, #ffed4e); color: white; padding: 15px; border-radius: 15px; cursor: pointer;" onclick="filterOrders('pending')">
                          <h5 id="pendingCountCard">0</h5>
                          <small>طلبات جديدة</small>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6 col-6 text-center mb-3">
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 15px; cursor: pointer;" onclick="filterOrders('confirmed')">
                          <h5 id="confirmedCountCard">0</h5>
                          <small>طلبات مؤكدة</small>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6 col-6 text-center mb-3">
                        <div style="background: linear-gradient(135deg, #17a2b8, #20c997); color: white; padding: 15px; border-radius: 15px; cursor: pointer;" onclick="filterOrders('delivered')">
                          <h5 id="deliveredCountCard">0</h5>
                          <small>طلبات مسلمة</small>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6 col-6 text-center mb-3">
                        <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 15px; border-radius: 15px;">
                          <h5 id="totalRevenue">0 ج</h5>
                          <small>إيرادات اليوم (شامل التوصيل)</small>
                        </div>
                      </div>
                    </div>
                    
                    <div id="ordersList"></div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Scripts -->
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/bootstrap.js"></script>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <!-- App Configuration (يجب أن يُحمَّل أولاً) -->
  <script src="js/config.js"></script>
  <!-- API Service -->
  <script src="js/api.js"></script>
  <!-- Admin Backend Manager -->
  <script src="js/admin-backend.js"></script>

  <script>
    // Global Variables
    let isAuthenticated = false;
    let currentTab = 'menu';
    let socket = null;
    
    // Menu Data
    let menuData = [
      {
        title: 'محشي ورق عنب بدبس الرمان',
        description: 'أوراق عنب طازجة محشوة بالأرز والخضروات مع نكهة دبس الرمان المميزة',
        items: [
          { name: 'صغير 15 قطعة', price: '190 ج', description: 'مثالي للوجبات الخفيفة' },
          { name: 'متوسط 30 قطعة', price: '270 ج', description: 'يكفي لشخصين' },
          { name: 'كبير 55 قطعة', price: '500 ج', description: 'مثالي للعائلات والضيوف' },
        ],
      },
      {
        title: 'فتة ورق عنب',
        description: 'ورق عنب مفروم مع الخبز المحمص والصلصة الشهية',
        items: [
          { name: 'صغير', price: '170 ج', description: 'حصة فردية' },
          { name: 'كبير', price: '240 ج', description: 'يكفي لشخصين' },
        ],
      },
      {
        title: 'محشي ورق عنب بنكهة الليمون',
        description: 'أوراق عنب محشوة بنكهة الليمون المنعشة',
        items: [
          { name: 'صغير 15 قطعة', price: '190 ج', description: 'نكهة منعشة ولذيذة' },
          { name: 'متوسط 30 قطعة', price: '270 ج', description: 'الحجم الأكثر طلباً' },
          { name: 'كبير 55 قطعة', price: '500 ج', description: 'للمناسبات الخاصة' },
        ],
      },
      {
        title: 'محشي بطاطس',
        description: 'بطاطس محشوة بالأرز والخضروات المتبلة',
        items: [
          { name: 'صغير', price: '130 ج', description: '6 قطع بطاطس متوسطة' },
          { name: 'كبير', price: '220 ج', description: '10 قطع بطاطس كبيرة' },
        ],
      },
      {
        title: 'محشي بصل',
        description: 'بصل محشو بالأرز واللحمة المفرومة',
        items: [
          { name: 'صغير', price: '160 ج', description: '8 حبات بصل متوسطة' },
          { name: 'كبير', price: '250 ج', description: '12 حبة بصل كبيرة' },
        ],
      },
      {
        title: 'محشي الكوسا اللبنية',
        description: 'كوسا صغيرة محشوة على الطريقة اللبنانية',
        items: [
          { name: 'صغير', price: '190 ج', description: '10 قطع كوسا صغيرة' },
          { name: 'كبير', price: '270 ج', description: '15 قطعة كوسا متنوعة' },
        ],
      },
      {
        title: 'أطباق الضيافة',
        description: 'مجموعة متنوعة من جميع الأصناف المحشوة',
        items: [
          { name: 'حجم متوسط', price: '420 ج', description: 'تشكيلة متوسطة من جميع الأصناف' },
          { name: 'حجم كبير', price: '700 ج', description: 'تشكيلة كاملة من جميع الأصناف' },
        ],
      },
      {
        title: 'الكبة السورية لحمة',
        description: 'كبة سورية أصيلة محشوة باللحمة المفرومة والتوابل',
        items: [
          { name: 'حجم صغير', price: '600 ج', description: 'كبة لذيذة للعائلة الصغيرة' },
          { name: 'حجم متوسط', price: '1000 ج', description: 'مثالية للعائلات المتوسطة' },
          { name: 'حجم كبير', price: '2000 ج', description: 'للمناسبات والضيوف' },
        ],
      },
      {
        title: 'سمبوسة لحمة',
        description: 'سمبوسة مقرمشة محشوة باللحمة المتبلة',
        items: [
          { name: 'حجم صغير', price: '170 ج', description: 'مقبلات خفيفة ولذيذة' },
          { name: 'حجم متوسط', price: '300 ج', description: 'كمية مناسبة للمشاركة' },
        ],
      },
      {
        title: 'مسخن رول',
        description: 'خبز رقيق محشو بالدجاج والبصل والسماق',
        items: [
          { name: 'حجم صغير', price: '180 ج', description: 'وجبة خفيفة مشبعة' },
          { name: 'حجم متوسط', price: '300 ج', description: 'وجبة كاملة ومرضية' },
          { name: 'حجم كبير', price: '600 ج', description: 'للمشاركة مع الأصدقاء' },
        ],
      },
      {
        title: 'السلطات',
        description: 'سلطات طازجة ومنعشة',
        items: [
          { name: 'سلطة فتوش', price: '90 ج', description: 'خضار مشكلة مع الخبر المحمص' },
          { name: 'سلطة التبولة', price: '90 ج', description: 'بقدونس مفروم مع الطماطم والليمون' },
        ],
      },
      {
        title: 'مكدوس شامي',
        description: 'باذنجان محشو بالجوز والفلفل الأحمر',
        items: [
          { name: '600 جرام', price: '220 ج', description: 'كمية مناسبة للعائلة الصغيرة' },
          { name: '1000 جرام', price: '290 ج', description: 'كمية كبيرة للعائلات' },
        ],
      },
      {
        title: 'ورق عنب بالزيت',
        description: 'ورق عنب على الطريقة الشامية بالزيت',
        items: [
          { name: 'صغير 600 جرام', price: '190 ج', description: 'كمية مناسبة للوجبات الخفيفة' },
          { name: 'متوسط 1000 جرام', price: '270 ج', description: 'كمية متوسطة للعائلة' },
          { name: 'كبير 2000 جرام', price: '500 ج', description: 'كمية كبيرة للمناسبات' },
        ],
      },
      {
        title: 'ميكس محاشي',
        description: 'تشكيلة مختارة من المحاشي المصرية في طبق واحد',
        items: [
          { name: 'طبق ملفوف', price: '180 ج', description: 'ملفوف محشي بالأرز والخضار' },
          { name: 'طبق بصل', price: '170 ج', description: 'بصل محشي بالأرز واللحمة' },
          { name: 'طبق بطاطس', price: '160 ج', description: 'بطاطس محشية بالأرز والخضار' },
          { name: 'طبق كوسه', price: '160 ج', description: 'كوسه محشية بالأرز والخضار' },
        ],
      },
    ];

    // Offers Data
    let offersData = [
      {
        title: 'عرض العائلة الكبيرة',
        description: 'وجبة عائلية مميزة تشمل جميع الأصناف الرئيسية بسعر خاص',
        originalPrice: '1500 ج',
        discountPrice: '1200 ج',
        discount: '20%',
      },
      {
        title: 'عرض الغداء السريع',
        description: 'وجبة غداء اقتصادية وسريعة التحضير',
        originalPrice: '300 ج',
        discountPrice: '250 ج',
        discount: '15%',
      },
      {
        title: 'عرض نهاية الأسبوع',
        description: 'عرض خاص لعطلة نهاية الأسبوع',
        originalPrice: '800 ج',
        discountPrice: '650 ج',
        discount: '25%',
      },
    ];

    // Mock Orders Data
    let currentOrderFilter = 'all';
    let ordersData = [
      {
        id: 1,
        customerName: 'أحمد محمد',
        phone: '01234567890',
        email: 'ahmed@email.com',
        items: [
          { name: 'محشي ورق عنب متوسط', quantity: 1, price: 270 },
          { name: 'سلطة فتوش', quantity: 1, price: 90 }
        ],
        total: 360,
        status: 'pending',
        time: '14:30',
        date: new Date().toLocaleDateString('ar-EG'),
        address: 'شارع الجامعة، الجيزة',
        paymentMethod: 'كاش',
        notes: 'يرجى التوصيل بسرعة'
      },
      {
        id: 2,
        customerName: 'فاطمة علي',
        phone: '01098765432',
        email: 'fatma@email.com',
        items: [
          { name: 'عرض العائلة الكبيرة', quantity: 1, price: 1200 }
        ],
        total: 1200,
        status: 'confirmed',
        time: '13:15',
        date: new Date().toLocaleDateString('ar-EG'),
        address: 'المعادي، القاهرة',
        paymentMethod: 'فودافون كاش',
        notes: 'للضيوف'
      },
      {
        id: 3,
        customerName: 'محمد حسن',
        phone: '01555444333',
        email: 'mohamed@email.com',
        items: [
          { name: 'كبة سورية صغير', quantity: 1, price: 600 },
          { name: 'سمبوسة متوسط', quantity: 1, price: 300 }
        ],
        total: 900,
        status: 'delivered',
        time: '12:45',
        date: new Date().toLocaleDateString('ar-EG'),
        address: 'مدينة نصر، القاهرة',
        paymentMethod: 'بطاقة ائتمان',
        notes: ''
      },
      {
        id: 4,
        customerName: 'سارة أحمد',
        phone: '01123456789',
        email: 'sara@email.com',
        items: [
          { name: 'محشي بطاطس كبير', quantity: 1, price: 220 },
          { name: 'سلطة التبولة', quantity: 2, price: 90 }
        ],
        total: 400,
        status: 'cancelled',
        time: '11:20',
        date: new Date().toLocaleDateString('ar-EG'),
        address: 'الزمالك، القاهرة',
        paymentMethod: 'انستاباي',
        notes: 'تم الإلغاء بطلب العميل'
      }
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
    });

    // Authentication Functions
    function checkAuth() {
      const savedAuth = localStorage.getItem('admin-auth');
      const savedTime = localStorage.getItem('admin-auth-time');
      
      if (savedAuth === 'true' && savedTime) {
        const loginTime = new Date(savedTime);
        const currentTime = new Date();
        const timeDiff = (currentTime - loginTime) / (1000 * 60 * 60); // hours
        
        if (timeDiff < 8) { // 8 hours session
          isAuthenticated = true;
          showDashboard();
          return;
        }
      }
      
      showLogin();
    }



    function showLogin() {
      document.getElementById('loginForm').style.display = 'flex';
      document.getElementById('adminDashboard').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      
      // تهيئة Socket.IO
      initSocket();
      
      renderMenuItems();
      renderOffers();
      loadOrders(); // تحميل الطلبات من الخادم  
      updateLastUpdateTime();
      
      // Welcome message
      setTimeout(() => {
        showNotification('أهلاً بك في لوحة تحكم مطعم زاد! 🎉', 'success');
      }, 500);
    }
    
    // تهيئة Socket.IO
    function initSocket() {
      try {
        const socketUrl = window.AppConfig ? 
          window.AppConfig.getSocketUrl() : 
          window.location.origin;
        socket = io(socketUrl);
        
        socket.on('connect', () => {
          console.log('🔗 الأدمن متصل بالخادم');
          socket.emit('join-admin'); // انضمام لغرفة الأدمن
        });
        
        // استقبال الطلبات الجديدة
        socket.on('newOrder', (orderData) => {
          console.log('🆕 طلب جديد وصل:', orderData);
          
          // إعادة تحميل الطلبات من الخادم
          loadOrders().then(() => {
            console.log('🔄 تم تحديث الطلبات بعد وصول طلب جديد');
            console.log('📊 Current tab:', currentTab);
            console.log('📦 عدد الطلبات الحالي:', ordersData.length);
            
            // إذا كان المستخدم في tab الطلبات، حدث العرض فوراً
            if (currentTab === 'orders') {
              console.log('🖥️ تحديث عرض الطلبات فوراً');
              renderOrders();
            }
          });
          
          // إظهار إشعار
          showNotification(`🎉 طلب جديد وصل من ${orderData.customerName} بقيمة ${orderData.totalPrice} ج.م`, 'success');
          
          // تشغيل صوت التنبيه
          playNewOrderSound();
          
          // إظهار badge الطلبات الجديدة
          const newOrdersBadge = document.getElementById('newOrdersBadge');
          if (newOrdersBadge && currentTab !== 'orders') {
            newOrdersBadge.style.display = 'inline-block';
            newOrdersBadge.style.animation = 'pulse 1s infinite';
          }
        });
        
        // استقبال تحديثات الطلبات
        socket.on('orderUpdated', (updateData) => {
          console.log('🔄 تحديث طلب:', updateData);
          loadOrders().then(() => {
            // إذا كان المستخدم في tab الطلبات، حدث العرض فوراً
            if (currentTab === 'orders') {
              renderOrders();
            }
          });
        });
        
        socket.on('disconnect', () => {
          console.log('❌ انقطع اتصال الأدمن بالخادم');
        });
        
      } catch (error) {
        console.error('خطأ في اتصال Socket.IO:', error);
      }
    }

    function login() {
      const password = document.getElementById('passwordInput').value;
      const currentHour = new Date().getHours();
      
      // Check time (6 AM to 11 PM)
      if (currentHour < 6 || currentHour >= 23) {
        showNotification('غير مسموح بالدخول في هذا الوقت! يمكن الدخول من 6 صباحاً إلى 11 مساءً', 'error');
        return;
      }
      
      // Simple password check (in real app, use proper authentication)
      // استخدم متغير البيئة أو كلمة مرور آمنة
      const validPassword = 'zad2024admin'; // غير هذا في بيئة الإنتاج
      if (password === validPassword) {
        isAuthenticated = true;
        localStorage.setItem('admin-auth', 'true');
        localStorage.setItem('admin-auth-time', new Date().toISOString());
        showNotification('تم تسجيل الدخول بنجاح', 'success');
        showDashboard();
      } else {
        showNotification('كلمة مرور خاطئة!', 'error');
        document.getElementById('passwordInput').value = '';
      }
    }

    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        isAuthenticated = false;
        localStorage.removeItem('admin-auth');
        localStorage.removeItem('admin-auth-time');
        showNotification('تم تسجيل الخروج بنجاح', 'success');
        showLogin();
      }
    }

    // Tab Management
    function showTab(tabName) {
      // Hide all content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected content and activate tab
      document.getElementById(tabName + 'Content').style.display = 'block';
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      currentTab = tabName;
      
      // Load specific content
      if (tabName === 'menu') {
        renderMenuItems();
      } else if (tabName === 'offers') {
        renderOffers();
      } else if (tabName === 'orders') {
        // إخفاء badge الطلبات الجديدة عند فتح tab الطلبات
        const ordersBadge = document.getElementById('newOrdersBadge');
        if (ordersBadge) {
          ordersBadge.style.display = 'none';
        }
        
        // جلب الطلبات من الباك إند
        if (window.adminBackend) {
          adminBackend.loadOrdersFromBackend().then(() => {
            renderOrders();
          });
        } else {
          // استخدام loadOrders مباشرة لضمان الحصول على أحدث البيانات
          loadOrders().then(() => {
            console.log('📋 تم تحميل وعرض الطلبات في tab الطلبات');
          });
        }
        
        // إخفاء مؤشر الطلبات الجديدة عند فتح تبويب الطلبات
        const newOrdersBadge = document.getElementById('newOrdersBadge');
        if (newOrdersBadge) {
          newOrdersBadge.style.display = 'none';
          newOrdersBadge.style.animation = '';
        }
      }
    }

    // Menu Management Functions
    
    function renderMenuItems() {
      const container = document.getElementById('menuItems');
      container.innerHTML = '';
      
      menuData.forEach((group, groupIndex) => {
        const groupHTML = `
          <div class="menu-item" style="margin-bottom: 30px; border: 2px solid #e9ecef; border-radius: 15px; padding: 25px;">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 style="color: #495057; font-weight: 600; font-size: 1.3rem;">${group.title}</h5>
                <p style="color: #6c757d; margin: 0; font-size: 1rem;">${group.description}</p>
              </div>
              <div class="d-flex gap-2">
                <button onclick="saveGroupChanges(${groupIndex})" class="save-btn" style="padding: 8px 20px; font-size: 14px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                  💾 حفظ المجموعة
                </button>
                <button onclick="deleteGroup(${groupIndex})" class="delete-btn" style="padding: 8px 15px; font-size: 14px;">
                  🗑️ حذف
                </button>
              </div>
            </div>
            <div class="row mb-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%); padding: 15px; border-radius: 10px; font-weight: 600; color: #495057;">
              <div class="col-lg-3 col-md-4"><i class="fa fa-cutlery"></i> اسم الصنف</div>
              <div class="col-lg-2 col-md-3"><i class="fa fa-money"></i> السعر</div>
              <div class="col-lg-5 col-md-4"><i class="fa fa-info-circle"></i> الوصف</div>
              <div class="col-lg-2 col-md-1"><i class="fa fa-cogs"></i> الإجراءات</div>
            </div>
            ${group.items.map((item, itemIndex) => `
              <div class="row align-items-center mb-3 p-3" style="background: rgba(255,255,255,0.9); border-radius: 12px; border: 1px solid #dee2e6; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05);" 
                   onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'" 
                   onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                <div class="col-lg-3 col-md-4">
                  <input type="text" value="${item.name}" 
                         onchange="updateItemName(${groupIndex}, ${itemIndex}, this.value)"
                         class="price-input" style="padding: 10px; font-size: 14px; font-weight: 600; border: 2px solid #e9ecef;" 
                         placeholder="اسم الصنف" />
                </div>
                <div class="col-lg-2 col-md-3">
                  <input type="text" value="${item.price}" 
                         onchange="updateItemPrice(${groupIndex}, ${itemIndex}, this.value)"
                         class="price-input" style="padding: 10px; font-size: 14px; font-weight: 600; color: #28a745; border: 2px solid #e9ecef;" 
                         placeholder="السعر" />
                </div>
                <div class="col-lg-5 col-md-4">
                  <textarea value="${item.description}" 
                         onchange="updateItemDescription(${groupIndex}, ${itemIndex}, this.value)"
                         class="price-input" style="padding: 10px; font-size: 14px; min-height: 45px; resize: vertical; border: 2px solid #e9ecef;" 
                         placeholder="وصف الصنف">${item.description}</textarea>
                </div>
                <div class="col-lg-2 col-md-1">
                  <div class="d-flex gap-1 flex-wrap">
                    <button onclick="saveItemChanges(${groupIndex}, ${itemIndex})" class="save-btn" style="padding: 8px 12px; font-size: 12px; background: #17a2b8;">
                      💾
                    </button>
                    <button onclick="deleteItem(${groupIndex}, ${itemIndex})" class="delete-btn" style="padding: 8px 12px; font-size: 12px;">
                      🗑️
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        container.innerHTML += groupHTML;
      });
    }

    function updateItemPrice(groupIndex, itemIndex, newPrice) {
      menuData[groupIndex].items[itemIndex].price = newPrice;
      // لا نحفظ تلقائياً، ننتظر الضغط على زر الحفظ
      showNotification('تم تحديث السعر - اضغط حفظ لتأكيد التغييرات', 'success');
    }

    function updateItemName(groupIndex, itemIndex, newName) {
      menuData[groupIndex].items[itemIndex].name = newName;
      // لا نحفظ تلقائياً، ننتظر الضغط على زر الحفظ
      showNotification('تم تحديث الاسم - اضغط حفظ لتأكيد التغييرات', 'success');
    }

    function updateItemDescription(groupIndex, itemIndex, newDescription) {
      menuData[groupIndex].items[itemIndex].description = newDescription;
      // لا نحفظ تلقائياً، ننتظر الضغط على زر الحفظ
      showNotification('تم تحديث الوصف - اضغط حفظ لتأكيد التغييرات', 'success');
    }

    function deleteItem(groupIndex, itemIndex) {
      if (confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
        menuData[groupIndex].items.splice(itemIndex, 1);
        renderMenuItems();
        saveData();
        showNotification('تم حذف العنصر بنجاح', 'success');
      }
    }

    function deleteGroup(groupIndex) {
      if (confirm('هل أنت متأكد من حذف هذه المجموعة بالكامل؟')) {
        menuData.splice(groupIndex, 1);
        renderMenuItems();
        saveData();
        showNotification('تم حذف المجموعة بنجاح', 'success');
      }
    }

    // دوال الحفظ الجديدة
    function saveItemChanges(groupIndex, itemIndex) {
      saveData();
      showNotification(`تم حفظ تغييرات "${menuData[groupIndex].items[itemIndex].name}" بنجاح ✅`, 'success');
    }

    function saveGroupChanges(groupIndex) {
      saveData();
      showNotification(`تم حفظ جميع تغييرات مجموعة "${menuData[groupIndex].title}" بنجاح ✅`, 'success');
    }

    function saveAllMenuChanges() {
      saveData();
      showNotification('تم حفظ جميع تغييرات القائمة بنجاح! 🎉', 'success');
    }

    function addNewItem() {
      const name = document.getElementById('newItemName').value;
      const price = document.getElementById('newItemPrice').value;
      const description = document.getElementById('newItemDescription').value;
      
      if (!name || !price) {
        showNotification('يرجى ملء اسم الصنف والسعر على الأقل', 'error');
        return;
      }
      
      // Add to first group or create new group
      if (menuData.length === 0) {
        menuData.push({
          title: 'أصناف جديدة',
          description: 'أصناف تم إضافتها حديثاً',
          items: []
        });
      }
      
      menuData[0].items.push({
        name: name,
        price: price,
        description: description || 'صنف لذيذ ومميز'
      });
      
      // Clear inputs
      document.getElementById('newItemName').value = '';
      document.getElementById('newItemPrice').value = '';
      document.getElementById('newItemDescription').value = '';
      
      renderMenuItems();
      saveData();
      showNotification('تم إضافة الصنف الجديد بنجاح', 'success');
    }

    // Offers Management Functions
    function renderOffers() {
      const container = document.getElementById('offersItems');
      container.innerHTML = '';
      
      offersData.forEach((offer, offerIndex) => {
        const offerHTML = `
          <div class="menu-item" style="border: 2px solid #ffc107; border-radius: 15px; padding: 25px; margin-bottom: 25px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 159, 0, 0.05) 100%);">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 style="color: #495057; font-weight: 600; font-size: 1.3rem;">${offer.title}</h5>
                <p style="color: #6c757d; margin: 0; font-size: 1rem;">${offer.description}</p>
              </div>
              <div class="d-flex gap-2">
                <button onclick="saveOfferChanges(${offerIndex})" class="save-btn" style="padding: 8px 20px; font-size: 14px; background: linear-gradient(135deg, #ffc107 0%, #ff9f00 100%);">
                  💾 حفظ العرض
                </button>
                <button onclick="deleteOffer(${offerIndex})" class="delete-btn" style="padding: 8px 15px; font-size: 14px;">
                  🗑️ حذف
                </button>
              </div>
            </div>
            <div class="row">
              <div class="col-md-3">
                <label style="font-weight: 600; color: #495057;">السعر الأصلي:</label>
                <input type="text" value="${offer.originalPrice}" 
                       onchange="updateOfferField(${offerIndex}, 'originalPrice', this.value)"
                       class="price-input" />
              </div>
              <div class="col-md-3">
                <label style="font-weight: 600; color: #495057;">سعر الخصم:</label>
                <input type="text" value="${offer.discountPrice}" 
                       onchange="updateOfferField(${offerIndex}, 'discountPrice', this.value)"
                       class="price-input" />
              </div>
              <div class="col-md-3">
                <label style="font-weight: 600; color: #495057;">نسبة الخصم:</label>
                <input type="text" value="${offer.discount}" 
                       onchange="updateOfferField(${offerIndex}, 'discount', this.value)"
                       class="price-input" />
              </div>
              <div class="col-md-3">
                <label style="font-weight: 600; color: #495057;">الوفر:</label>
                <div style="background: #28a745; color: white; padding: 12px; border-radius: 10px; text-align: center; font-weight: 600;">
                  ${parseInt(offer.originalPrice) - parseInt(offer.discountPrice)} ج
                </div>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += offerHTML;
      });
    }

    function updateOfferField(offerIndex, field, newValue) {
      offersData[offerIndex][field] = newValue;
      renderOffers();
      // لا نحفظ تلقائياً، ننتظر الضغط على زر الحفظ
      showNotification('تم تحديث العرض - اضغط حفظ لتأكيد التغييرات', 'success');
    }

    // دوال حفظ العروض
    function saveOfferChanges(offerIndex) {
      saveData();
      showNotification(`تم حفظ تغييرات العرض "${offersData[offerIndex].title}" بنجاح ✅`, 'success');
    }

    function saveAllOffersChanges() {
      saveData();
      showNotification('تم حفظ جميع تغييرات العروض بنجاح! 🎉', 'success');
    }

    function deleteOffer(offerIndex) {
      if (confirm('هل أنت متأكد من حذف هذا العرض؟')) {
        offersData.splice(offerIndex, 1);
        renderOffers();
        saveData();
        showNotification('تم حذف العرض بنجاح', 'success');
      }
    }

    function addNewOffer() {
      const title = document.getElementById('newOfferTitle').value;
      const description = document.getElementById('newOfferDescription').value;
      const originalPrice = document.getElementById('newOfferOriginalPrice').value;
      const discountPrice = document.getElementById('newOfferDiscountPrice').value;
      const discount = document.getElementById('newOfferDiscount').value;
      
      if (!title || !originalPrice || !discountPrice) {
        showNotification('يرجى ملء العنوان والأسعار على الأقل', 'error');
        return;
      }
      
      offersData.push({
        title: title,
        description: description || 'عرض مميز وخاص',
        originalPrice: originalPrice,
        discountPrice: discountPrice,
        discount: discount || '0%'
      });
      
      // Clear inputs
      document.getElementById('newOfferTitle').value = '';
      document.getElementById('newOfferDescription').value = '';
      document.getElementById('newOfferOriginalPrice').value = '';
      document.getElementById('newOfferDiscountPrice').value = '';
      document.getElementById('newOfferDiscount').value = '';
      
      renderOffers();
      saveData();
      showNotification('تم إضافة العرض الجديد بنجاح', 'success');
    }

    // Orders Management Functions

    // تحميل الطلبات من الخادم
    async function loadOrders() {
      try {
        console.log('🔄 جاري تحميل الطلبات من الخادم...');
        
        // استخدام API endpoint للطلبات الحديثة (آخر 48 ساعة)
        const apiUrl = window.AppConfig ? 
          window.AppConfig.getApiUrl('orders?recent=true') : 
          '/api/orders?recent=true';
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('✅ تم تحميل الطلبات:', result);
        
        // تحديث بيانات الطلبات
        if (result.success && Array.isArray(result.data)) {
          // جلب قائمة الطلبات المحذوفة
          const deletedOrders = JSON.parse(localStorage.getItem('zad-deleted-orders') || '[]');
          const deletedOrdersSet = new Set(deletedOrders);
          
          // جلب التغييرات المحلية
          const localOrders = JSON.parse(localStorage.getItem('zad-orders-data') || '[]');
          const localOrdersMap = new Map(localOrders.map(order => [order._id, order]));
          
          // فلترة الطلبات المحذوفة ودمج التحديثات المحلية
          ordersData = result.data
            .filter(serverOrder => !deletedOrdersSet.has(serverOrder._id)) // تجاهل المحذوفة
            .map(serverOrder => {
              const localOrder = localOrdersMap.get(serverOrder._id);
              // إذا وُجد تحديث محلي، استخدمه، وإلا استخدم بيانات الخادم
              return localOrder && localOrder.updatedAt ? localOrder : serverOrder;
            });
          
          console.log(`📊 تم تحميل ${ordersData.length} طلب من آخر 48 ساعة (بعد فلترة المحذوفة)`);
        } else {
          ordersData = [];
        }
        
        // عرض الطلبات إذا كان المستخدم في tab الطلبات
        if (currentTab === 'orders') {
          renderOrders();
        }
        
        console.log('✅ تم تحديث بيانات الطلبات بنجاح، عدد الطلبات:', ordersData.length);
        
      } catch (error) {
        console.error('❌ خطأ في تحميل الطلبات:', error);
        showNotification('فشل في تحميل الطلبات: ' + error.message, 'error');
        ordersData = [];
        if (currentTab === 'orders') {
          renderOrders();
        }
      }
    }

    function renderOrders(filterStatus = 'all') {
      console.log('🎨 بدء عرض الطلبات - Filter:', filterStatus, 'عدد الطلبات:', ordersData.length);
      updateOrderStats();
      const container = document.getElementById('ordersList');
      
      // Filter orders based on status
      let filteredOrders = ordersData;
      if (filterStatus !== 'all') {
        filteredOrders = ordersData.filter(order => order.status === filterStatus);
      }
      
      if (filteredOrders.length === 0) {
        const filterText = {
          'all': 'لا توجد طلبات',
          'pending': 'لا توجد طلبات جديدة',
          'confirmed': 'لا توجد طلبات مؤكدة',
          'delivered': 'لا توجد طلبات مسلمة',
          'cancelled': 'لا توجد طلبات ملغية'
        };
        
        container.innerHTML = `
          <div class="text-center py-5">
            <div style="font-size: 4rem; margin-bottom: 20px;">📋</div>
            <h4 style="color: #6c757d;">${filterText[filterStatus]}</h4>
            <p style="color: #adb5bd;">سيتم عرض الطلبات هنا عند وصولها</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      filteredOrders.forEach((order, orderIndex) => {
        const actualIndex = ordersData.findIndex(o => o._id === order._id);
        const statusClass = `status-${order.status}`;
        const statusText = {
          'pending': '🟡 جديد',
          'confirmed': '🟢 مؤكد',
          'delivered': '🔵 مسلم',
          'cancelled': '🔴 ملغي'
        };
        
        const paymentMethodIcon = {
          'كاش': '💵',
          'فودافون كاش': '📱',
          'انستاباي': '💳',
          'بطاقة ائتمان': '💳'
        };
        
        const orderHTML = `
          <div class="order-card ${order.status === 'pending' ? 'border-warning' : order.status === 'cancelled' ? 'border-danger' : 'border-success'}" 
               style="border-width: 3px;" 
               data-order-index="${actualIndex}">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 style="margin: 0; font-weight: 700; color: #333;">
                  طلب #${order._id.slice(-6)} - ${order.customerName}
                </h5>
                <div class="mt-2">
                  <span class="badge badge-info">📞 ${order.phoneNumber}</span>
                  <span class="badge badge-secondary">⏰ ${new Date(order.createdAt).toLocaleTimeString('ar-EG')}</span>
                  <span class="badge badge-primary">📅 ${new Date(order.createdAt).toLocaleDateString('ar-EG')}</span>
                </div>
              </div>
              <div class="text-right">
                <div class="mb-2">
                  <span class="badge badge-lg ${order.status === 'pending' ? 'badge-warning' : order.status === 'confirmed' ? 'badge-success' : order.status === 'delivered' ? 'badge-info' : 'badge-danger'}" style="font-size: 14px; padding: 8px 12px;">
                    ${statusText[order.status]}
                  </span>
                </div>
                <div style="font-size: 24px; font-weight: 700; color: #28a745;">
                  ${order.totalPrice} ج.م
                  <div style="font-size: 14px; color: #6c757d;">
                    (${order.totalPrice - 65} ج طعام + 65 ج توصيل)
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Customer Details -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="bg-light p-3 rounded">
                  <h6><i class="fa fa-user"></i> بيانات العميل:</h6>
                  <p class="mb-1"><strong>الاسم:</strong> ${order.customerName}</p>
                  <p class="mb-1"><strong>الهاتف:</strong> ${order.phoneNumber}</p>
                  ${order.email ? `<p class="mb-1"><strong>الإيميل:</strong> ${order.email}</p>` : ''}
                  <p class="mb-0"><strong>العنوان:</strong> ${order.address}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="bg-light p-3 rounded">
                  <h6><i class="fa fa-credit-card"></i> تفاصيل الدفع:</h6>
                  <p class="mb-1">
                    <strong>طريقة الدفع:</strong> 
                    ${paymentMethodIcon[order.paymentMethod] || '💰'} ${order.paymentMethod}
                  </p>
                  <p class="mb-1"><strong>المجموع:</strong> ${order.totalPrice} ج.م</p>
                  <p class="mb-1" style="font-size: 12px; color: #6c757d;">
                    <strong>التفصيل:</strong> ${order.totalPrice - 65} ج (طعام) + 65 ج (توصيل)
                  </p>
                  ${order.notes ? `<p class="mb-0"><strong>ملاحظات:</strong> ${order.notes}</p>` : ''}
                </div>
              </div>
            </div>
            
            <!-- Order Items -->
            <div class="mb-3">
              <h6><i class="fa fa-shopping-cart"></i> تفاصيل الطلب:</h6>
              <div class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead class="thead-light">
                    <tr>
                      <th>الصنف</th>
                      <th>الكمية</th>
                      <th>السعر</th>
                      <th>المجموع</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${order.items.map(item => `
                      <tr>
                        <td>${item.productName || item.name || 'غير محدد'}</td>
                        <td><span class="badge badge-secondary">${item.quantity}</span></td>
                        <td>${item.priceAtOrder || item.price || 0} ج</td>
                        <td><strong>${(item.priceAtOrder || item.price || 0) * item.quantity} ج</strong></td>
                      </tr>
                    `).join('')}
                    <tr class="table-warning">
                      <td><strong>رسوم التوصيل</strong></td>
                      <td>1</td>
                      <td>65 ج</td>
                      <td><strong>65 ج</strong></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="table-success">
                      <th colspan="3">المجموع الكلي:</th>
                      <th style="font-size: 18px;">${order.totalPrice} ج.م</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap justify-content-between">
              <div>
                ${order.status === 'pending' ? `
                  <button onclick="updateOrderStatus(${actualIndex}, 'confirmed')" 
                          class="btn btn-success btn-sm mr-2">
                    <i class="fa fa-check"></i> تأكيد الطلب
                  </button>
                  <button onclick="updateOrderStatus(${actualIndex}, 'cancelled')" 
                          class="btn btn-danger btn-sm">
                    <i class="fa fa-times"></i> إلغاء الطلب
                  </button>
                ` : ''}
                
                ${order.status === 'paid' ? `
                  <div class="mb-2">
                    <span class="badge badge-success badge-lg mr-2">
                      <i class="fa fa-credit-card"></i> مدفوع مسبقاً
                    </span>
                    ${order.paymentDetails?.transactionId ? `
                      <small class="text-muted">ID: ${order.paymentDetails.transactionId}</small>
                    ` : ''}
                  </div>
                  <button onclick="updateOrderStatus(${actualIndex}, 'confirmed')" 
                          class="btn btn-success btn-sm mr-2">
                    <i class="fa fa-check"></i> تأكيد الطلب
                  </button>
                  <button onclick="updateOrderStatus(${actualIndex}, 'cancelled')" 
                          class="btn btn-danger btn-sm">
                    <i class="fa fa-times"></i> إلغاء الطلب
                  </button>
                ` : ''}
                
                ${order.status === 'confirmed' ? `
                  <button onclick="updateOrderStatus(${actualIndex}, 'delivered')" 
                          class="btn btn-info btn-sm mr-2">
                    <i class="fa fa-truck"></i> تم التسليم
                  </button>
                  <button onclick="updateOrderStatus(${actualIndex}, 'cancelled')" 
                          class="btn btn-warning btn-sm">
                    <i class="fa fa-ban"></i> إلغاء
                  </button>
                ` : ''}
                
                ${order.status === 'delivered' ? `
                  <span class="btn btn-success btn-sm disabled">
                    <i class="fa fa-check-circle"></i> تم التسليم بنجاح
                  </span>
                ` : ''}
                
                ${order.status === 'cancelled' ? `
                  <span class="btn btn-danger btn-sm disabled">
                    <i class="fa fa-ban"></i> طلب ملغي
                  </span>
                ` : ''}
              </div>
              
              <div>
                <button onclick="printOrder(${actualIndex})" class="btn btn-outline-primary btn-sm mr-2">
                  <i class="fa fa-print"></i> طباعة
                </button>
                <button onclick="deleteOrder(${actualIndex})" 
                        class="btn btn-outline-danger btn-sm"
                        title="حذف الطلب نهائياً من قاعدة البيانات">
                  <i class="fa fa-trash"></i> حذف نهائي
                </button>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += orderHTML;
      });
    }

    function updateOrderStats() {
      const all = ordersData.length;
      const pending = ordersData.filter(o => o.status === 'pending').length;
      const confirmed = ordersData.filter(o => o.status === 'confirmed').length;
      const delivered = ordersData.filter(o => o.status === 'delivered').length;
      const cancelled = ordersData.filter(o => o.status === 'cancelled').length;
      // حساب إيرادات اليوم فقط مع إضافة 65 ج رسوم توصيل لكل طلب مسلم
      const deliveryFee = 65;
      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
      
      const totalRevenue = ordersData.filter(o => {
        const orderDate = new Date(o.orderDate);
        return o.status === 'delivered' && orderDate >= todayStart && orderDate < todayEnd;
      }).reduce((sum, o) => {
        const orderTotal = (o.total || 0) + deliveryFee; // إضافة رسوم التوصيل
        return sum + orderTotal;
      }, 0);
      
      // Update tab counts
      const allCountEl = document.getElementById('allCount');
      const pendingCountEl = document.getElementById('pendingCount');
      const confirmedCountEl = document.getElementById('confirmedCount');
      const deliveredCountEl = document.getElementById('deliveredCount');
      const cancelledCountEl = document.getElementById('cancelledCount');
      
      if (allCountEl) allCountEl.textContent = all;
      if (pendingCountEl) pendingCountEl.textContent = pending;
      if (confirmedCountEl) confirmedCountEl.textContent = confirmed;
      if (deliveredCountEl) deliveredCountEl.textContent = delivered;
      if (cancelledCountEl) cancelledCountEl.textContent = cancelled;
      
      // Update cards
      const pendingCountCardEl = document.getElementById('pendingCountCard');
      const confirmedCountCardEl = document.getElementById('confirmedCountCard');
      const deliveredCountCardEl = document.getElementById('deliveredCountCard');
      const totalRevenueEl = document.getElementById('totalRevenue');
      
      if (pendingCountCardEl) pendingCountCardEl.textContent = pending;
      if (confirmedCountCardEl) confirmedCountCardEl.textContent = confirmed;
      if (deliveredCountCardEl) deliveredCountCardEl.textContent = delivered;
      if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue + ' ج';
      
      // Show notification for new orders
      if (pending > 0) {
        playNotificationSound();
      }
    }
    
    function filterOrders(status) {
      currentOrderFilter = status;
      
      // Update active tab
      document.querySelectorAll('[id$="OrdersTab"]').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.add('btn-outline-primary');
        tab.classList.remove('btn-primary');
      });
      
      const activeTab = document.getElementById(status + 'OrdersTab') || document.getElementById('allOrdersTab');
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.classList.remove('btn-outline-primary');
        activeTab.classList.add('btn-primary');
      }
      
      renderOrders(status);
    }
    
    async function refreshOrders() {
      await loadOrders();
      showNotification('تم تحديث الطلبات', 'success');
    }
    
    function addTestOrder() {
      const customerNames = ['أحمد محمد', 'فاطمة أحمد', 'محمد علي', 'نور الهدى', 'عبدالله سالم', 'مريم حسن'];
      const addresses = [
        'شارع النيل، الزمالك، القاهرة',
        'شارع التحرير، وسط البلد، القاهرة', 
        'شارع الهرم، الجيزة',
        'كورنيش النيل، المعادي، القاهرة',
        'شارع المقطم، القاهرة الجديدة',
        'شارع البحر الأحمر، الإسكندرية'
      ];
      const paymentMethods = ['كاش', 'فودافون كاش', 'انستاباي', 'بطاقة ائتمان'];
      
      const randomCustomer = customerNames[Math.floor(Math.random() * customerNames.length)];
      const randomAddress = addresses[Math.floor(Math.random() * addresses.length)]; 
      const randomPayment = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
      
      const testOrder = {
        id: Date.now(),
        customerName: randomCustomer,
        phone: '0123456789' + Math.floor(Math.random() * 10),
        address: randomAddress,
        email: randomCustomer.replace(' ', '.').toLowerCase() + '@example.com',
        notes: 'طلب تجريبي من لوحة الأدمن',
        items: [
          { name: 'برجر لحم مشوي', quantity: Math.floor(Math.random() * 3) + 1, price: 45 },
          { name: 'بطاطس مقلية كبيرة', quantity: 1, price: 20 },
          { name: 'مشروب غازي', quantity: Math.floor(Math.random() * 2) + 1, price: 12 }
        ],
        total: 0, // سيتم حسابه
        paymentMethod: randomPayment,
        status: 'pending',
        date: new Date().toLocaleDateString('ar-EG'),
        time: new Date().toLocaleTimeString('ar-EG', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        }),
        timestamp: Date.now()
      };
      
      // حساب المجموع
      testOrder.total = testOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      ordersData.unshift(testOrder);
      saveData();
      updateOrderStats();
      renderOrders(currentOrderFilter);
      
      // تشغيل صوت إشعار وإظهار مؤشر
      playNewOrderSound();
      showNotification(`🎉 تم إضافة طلب تجريبي من ${randomCustomer} بقيمة ${testOrder.total + 65} ج.م (شامل التوصيل)`, 'success');
      
      // إظهار مؤشر الطلب الجديد إذا لم نكن في تبويب الطلبات
      const newOrdersBadge = document.getElementById('newOrdersBadge');
      if (newOrdersBadge && currentTab !== 'orders') {
        newOrdersBadge.style.display = 'inline-block';
        newOrdersBadge.style.animation = 'pulse 1s infinite';
      }
    }
    
    function playNotificationSound() {
      // Create audio context for notification sound
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('Audio notification not supported');
      }
    }
    
    function printOrder(orderIndex) {
      const order = ordersData[orderIndex];
      if (!order) return;
      
      // Create printable content
      const printContent = `
        <div style="font-family: Arial; padding: 20px; direction: rtl;">
          <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px;">
            <h1 style="color: #ffbe33;">مطعم زاد</h1>
            <h2>فاتورة طلب #${order.id}</h2>
            <p>${order.date} - ${order.time}</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3>بيانات العميل:</h3>
            <p><strong>الاسم:</strong> ${order.customerName}</p>
            <p><strong>الهاتف:</strong> ${order.phone}</p>
            <p><strong>العنوان:</strong> ${order.address}</p>
            <p><strong>طريقة الدفع:</strong> ${order.paymentMethod}</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3>تفاصيل الطلب:</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="background: #f8f9fa;">
                <th style="border: 1px solid #ddd; padding: 8px;">الصنف</th>
                <th style="border: 1px solid #ddd; padding: 8px;">الكمية</th>
                <th style="border: 1px solid #ddd; padding: 8px;">السعر</th>
                <th style="border: 1px solid #ddd; padding: 8px;">المجموع</th>
              </tr>
              ${order.items.map(item => `
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">${item.productName || item.name || 'غير محدد'}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.quantity}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.priceAtOrder || item.price || 0} ج</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${(item.priceAtOrder || item.price || 0) * item.quantity} ج</td>
                </tr>
              `).join('')}
              <tr style="background: #fff3cd;">
                <td style="border: 1px solid #ddd; padding: 8px;"><strong>رسوم التوصيل</strong></td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">1</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">65 ج</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;"><strong>65 ج</strong></td>
              </tr>
              <tr style="background: #e8f5e8; font-weight: bold;">
                <td colspan="3" style="border: 1px solid #ddd; padding: 8px;">المجموع الكلي:</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 18px;">${order.totalPrice} ج.م</td>
              </tr>
            </table>
          </div>
          
          ${order.notes ? `
          <div style="margin-bottom: 20px;">
            <h3>ملاحظات:</h3>
            <p>${order.notes}</p>
          </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
            <p>شكراً لاختياركم مطعم زاد</p>
            <p>للطلبات: 01234567890</p>
          </div>
        </div>
      `;
      
      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    function updateOrderStatus(orderIndex, newStatus) {
      ordersData[orderIndex].status = newStatus;
      renderOrders();
      saveData();
      
      const statusMessages = {
        'confirmed': 'تم تأكيد الطلب',
        'delivered': 'تم تسليم الطلب',
        'cancelled': 'تم إلغاء الطلب'
      };
      
      showNotification(statusMessages[newStatus], 'success');
    }

    async function deleteOrder(orderIndex) {
      const order = ordersData[orderIndex];
      
      if (!order || !order._id) {
        showNotification('خطأ: معرف الطلب غير موجود', 'error');
        return;
      }
      
      const customerName = order.customerName || 'غير محدد';
      const orderId = order._id.slice(-6); // آخر 6 أرقام للعرض
      
      if (confirm(`هل أنت متأكد من حذف طلب ${customerName} (#${orderId})؟\n\n⚠️ تحذير: هذا الإجراء لا يمكن التراجع عنه!`)) {
        try {
          console.log(`🗑️ حذف الطلب ${order._id} للعميل ${customerName}`);
          
          // حذف من الباك إند (من قاعدة البيانات)
          const apiUrl = window.AppConfig ? 
            window.AppConfig.getApiUrl(`orders/${order._id}`) : 
            `/api/orders/${order._id}`;
          const response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message || 'فشل في حذف الطلب من الخادم');
          }
          
          // إذا كان الطلب مدفوع وتم استرداد المبلغ
          if (result.refundDetails) {
            showNotification(`تم حذف الطلب واسترداد ${result.refundDetails.amount} ج.م بنجاح 💰`, 'success');
          } else {
            showNotification(`تم حذف طلب ${customerName} بنجاح ✅`, 'success');
          }
          
          // حذف الطلب من البيانات المحلية فوراً
          ordersData.splice(orderIndex, 1);
          
          // حفظ قائمة الطلبات المحذوفة
          const deletedOrders = JSON.parse(localStorage.getItem('zad-deleted-orders') || '[]');
          deletedOrders.push(order._id);
          localStorage.setItem('zad-deleted-orders', JSON.stringify(deletedOrders));
          
          // حفظ البيانات المحدثة
          localStorage.setItem('zad-orders-data', JSON.stringify(ordersData));
          
          // إعادة عرض الطلبات فوراً
          renderOrders();
          
          console.log(`✅ تم حذف الطلب ${order._id} بنجاح وإزالته من العرض`);
          
        } catch (error) {
          console.error('❌ خطأ في حذف الطلب:', error);
          showNotification('فشل في حذف الطلب: ' + error.message, 'error');
        }
      }
    }

    // Utility Functions
    function saveData() {
      const now = new Date();
      localStorage.setItem('zad-menu-data', JSON.stringify(menuData));
      localStorage.setItem('zad-offers-data', JSON.stringify(offersData));
      localStorage.setItem('zad-orders-data', JSON.stringify(ordersData));
      localStorage.setItem('zad-last-update', now.toISOString());
      updateLastUpdateTime();
    }
    
    function updateLastUpdateTime() {
      const lastUpdate = localStorage.getItem('zad-last-update');
      const element = document.getElementById('lastUpdate');
      if (lastUpdate && element) {
        const date = new Date(lastUpdate);
        element.textContent = `آخر تحديث: ${date.toLocaleString('ar-EG')}`;
      } else if (element) {
        element.textContent = 'لم يتم الحفظ بعد';
      }
    }

    async function loadData() {
      console.log('🔄 جاري جلب البيانات من الباك إند...');
      
      try {
        // جلب البيانات من الباك إند
        if (window.adminBackend) {
          // جلب القائمة
          menuData = await adminBackend.loadMenuFromBackend();
          
          // جلب الطلبات
          await adminBackend.loadOrdersFromBackend();
          
          console.log('✅ تم جلب البيانات من الباك إند بنجاح');
        } else {
          console.warn('⚠️ Admin Backend غير متاح، استخدام localStorage');
          
          // fallback للـ localStorage
          const savedMenu = localStorage.getItem('zad-menu-data');
          const savedOffers = localStorage.getItem('zad-offers-data');
          const savedOrders = localStorage.getItem('zad-orders-data');
          
          if (savedMenu) menuData = JSON.parse(savedMenu);
          if (savedOffers) offersData = JSON.parse(savedOffers);
          if (savedOrders) {
            ordersData = JSON.parse(savedOrders);
            console.log('Orders loaded:', ordersData.length, 'orders');
          }
        }
      } catch (error) {
        console.error('❌ خطأ في جلب البيانات:', error);
        
        // fallback للـ localStorage في حالة الخطأ
        const savedMenu = localStorage.getItem('zad-menu-data');
        const savedOffers = localStorage.getItem('zad-offers-data');
        const savedOrders = localStorage.getItem('zad-orders-data');
        
        if (savedMenu) menuData = JSON.parse(savedMenu);
        if (savedOffers) offersData = JSON.parse(savedOffers);
        if (savedOrders) {
          ordersData = JSON.parse(savedOrders);
        }
      }
    }

    function exportData() {
      const data = {
        menu: menuData,
        offers: offersData,
        orders: ordersData,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `zad-data-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('تم تصدير البيانات بنجاح', 'success');
    }

    function resetData() {
      if (confirm('هل أنت متأكد من إعادة تعيين جميع البيانات؟ سيتم فقدان جميع التعديلات!')) {
        localStorage.removeItem('zad-menu-data');
        localStorage.removeItem('zad-offers-data');
        localStorage.removeItem('zad-orders-data');
        location.reload();
      }
    }

    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Load saved data on init
    loadData();
    
    // انضمام لغرفة الأدمن عند تحميل الصفحة
    setTimeout(() => {
      if (window.adminBackend) {
        adminBackend.joinAdminRoom();
        console.log('👤 تم الانضمام لغرفة الأدمن');
      }
    }, 2000);
    
    // Setup notification system
    setupNotificationSystem();
    checkForNewOrders();

    function showNotification(message, type = 'info') {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification-toast');
      existingNotifications.forEach(n => n.remove());
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification-toast alert alert-${type} position-fixed`;
      notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        border: none;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <span style="font-weight: 500;">${message}</span>
          <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove after 4 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        }
      }, 4000);
    }
    
    async function updateOrderStatus(index, newStatus) {
      console.log(`🔄 طلب تحديث الطلب index=${index}, newStatus=${newStatus}`);
      console.log('📊 ordersData.length:', ordersData.length);
      
      if (index >= 0 && index < ordersData.length) {
        const order = ordersData[index];
        console.log('📋 Order data:', order);
        const oldStatus = order.status;
        
        try {
          // تحديث في الباك إند
          if (order._id) {
            console.log(`🔄 تحديث الطلب ${order._id} من ${oldStatus} إلى ${newStatus}`);
            
            // استدعاء API مباشرة
            const apiUrl = window.AppConfig ? 
              window.AppConfig.getApiUrl(`orders/${order._id}`) : 
              `/api/orders/${order._id}`;
            const response = await fetch(apiUrl, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ status: newStatus })
            });
            
            const result = await response.json();
            if (!result.success) {
              throw new Error(result.message || 'فشل في تحديث الطلب');
            }
            
            // تحديث البيانات المحلية فوراً
            order.status = newStatus;
            order.updatedAt = new Date().toISOString(); // إضافة timestamp للتحديث
            
            // حفظ التغييرات في localStorage للثبات
            localStorage.setItem('zad-orders-data', JSON.stringify(ordersData));
            
            // إعادة عرض الطلبات فوراً (بدون إعادة تحميل من الخادم)
            console.log(`🔄 إعادة عرض الطلبات بعد تحديث الطلب إلى ${newStatus}`);
            console.log(`📊 Current filter: ${currentOrderFilter}`);
            
            // إعادة عرض بالفلتر الحالي
            renderOrders(currentOrderFilter);
            
            // إذا تم إلغاء الطلب وكنا في فلتر "pending"، انتقل لـ "all" أو "cancelled"
            if (newStatus === 'cancelled' && currentOrderFilter === 'pending') {
              console.log('🔄 انتقال تلقائي لعرض الطلبات الملغية');
              filterOrders('cancelled');
            }
            
          } else {
            console.warn('⚠️ لا يوجد ID للطلب');
            throw new Error('معرف الطلب مفقود');
          }
          
          const statusMessages = {
            'pending': 'تم تغيير حالة الطلب إلى: في الانتظار',
            'confirmed': 'تم تأكيد الطلب بنجاح ✅',
            'delivered': 'تم تسليم الطلب بنجاح 🚚',
            'cancelled': 'تم إلغاء الطلب ❌'
          };
          
          showNotification(statusMessages[newStatus] || 'تم تحديث حالة الطلب', 'success');
          
        } catch (error) {
          console.error('❌ خطأ في تحديث حالة الطلب:', error);
          showNotification('فشل في تحديث حالة الطلب: ' + error.message, 'error');
        }
        
        // Play sound for status changes
        if (newStatus === 'confirmed' || newStatus === 'delivered') {
          playNotificationSound();
        }
      }
    }

    // Auto-save every 30 seconds
    setInterval(saveData, 30000);
    
    // Notification System Functions
    let lastOrderCount = 0;
    
    function setupNotificationSystem() {
      // Initialize last order count
      lastOrderCount = ordersData.length;
      
      // Check for new orders every 5 seconds
      setInterval(checkForNewOrders, 5000);
      
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
    
    function checkForNewOrders() {
      // إعادة تحميل البيانات من localStorage قبل المقارنة
      loadData();
      const currentOrderCount = ordersData.length;
      
      console.log('Checking for new orders:', currentOrderCount, 'vs', lastOrderCount);
      
      if (currentOrderCount > lastOrderCount) {
        const newOrdersCount = currentOrderCount - lastOrderCount;
        const latestOrder = ordersData[0]; // أحدث طلب
        
        // إظهار إشعار في الصفحة
        showNotification(`🎉 طلب جديد وصل من ${latestOrder.customerName} بقيمة ${latestOrder.total + 65} ج.م (شامل التوصيل)`, 'success');
        
        // إشعار المتصفح
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('طلب جديد - مطعم زاد', {
            body: `طلب من ${latestOrder.customerName} بقيمة ${latestOrder.total + 65} ج.م (شامل التوصيل)`,
            icon: 'images/favicon.png',
            badge: 'images/favicon.png'
          });
        }
        
        // تشغيل صوت إشعار
        playNewOrderSound();
        
        // تحديث عداد الطلبات في التبويبات
        updateOrderStats();
        renderOrders();
        
        // إضافة تأثير بصري لتبويب الطلبات
        const ordersTab = document.getElementById('ordersTab');
        const newOrdersBadge = document.getElementById('newOrdersBadge');
        
        if (ordersTab) {
          ordersTab.style.animation = 'pulse 1s infinite';
          setTimeout(() => {
            ordersTab.style.animation = '';
          }, 5000);
        }
        
        // إظهار مؤشر الطلبات الجديدة
        if (newOrdersBadge) {
          newOrdersBadge.style.display = 'inline-block';
          newOrdersBadge.style.animation = 'pulse 1s infinite';
        }
        
        lastOrderCount = currentOrderCount;
      }
    }
    
    function playNewOrderSound() {
      try {
        // إنشاء صوت إشعار مميز للطلبات الجديدة
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // نغمة ترحيبية للطلب الجديد
        const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        
        frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.15);
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.15);
          gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + index * 0.15 + 0.05);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.15 + 0.15);
          
          oscillator.start(audioContext.currentTime + index * 0.15);
          oscillator.stop(audioContext.currentTime + index * 0.15 + 0.15);
        });
        
      } catch (error) {
        console.log('لا يمكن تشغيل صوت الإشعار');
      }
    }
    
    function refreshOrders() {
      loadData();
      renderOrders();
      showNotification('تم تحديث الطلبات بنجاح', 'info');
    }
    
    function exportOrders() {
      try {
        const dataStr = JSON.stringify(ordersData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `orders-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showNotification('تم تصدير الطلبات بنجاح', 'success');
      } catch (error) {
        console.error('خطأ في تصدير الطلبات:', error);
        showNotification('حدث خطأ في تصدير الطلبات', 'danger');
      }
    }
    
    function debugLocalStorage() {
      console.log('=== تشخيص البيانات ===');
      console.log('Orders in localStorage:', localStorage.getItem('zad-orders-data'));
      console.log('Orders in memory:', ordersData);
      console.log('Last order count:', lastOrderCount);
      
      // إظهار في نافذة منبثقة أيضاً
      const ordersInStorage = JSON.parse(localStorage.getItem('zad-orders-data') || '[]');
      const message = `
        البيانات في localStorage: ${ordersInStorage.length} طلب
        البيانات في الذاكرة: ${ordersData.length} طلب
        آخر عداد: ${lastOrderCount}
        
        ${ordersInStorage.length > 0 ? 'أحدث طلب: ' + ordersInStorage[0].customerName : 'لا توجد طلبات'}
      `;
      
      alert(message);
      showNotification(`تم العثور على ${ordersInStorage.length} طلب في قاعدة البيانات`, 'info');
    }
    
    function syncMenuToWebsite() {
      try {
        // حفظ البيانات أولاً
        saveData();
        
        // إجبار إشارة تحديث للموقع
        const syncSignal = {
          timestamp: Date.now(),
          action: 'force_sync',
          message: 'تحديث من لوحة الأدمن'
        };
        
        localStorage.setItem('menu-sync-signal', JSON.stringify(syncSignal));
        
        // تشغيل صوت تأكيد
        playNotificationSound();
        
        showNotification('🔄 تم إرسال إشارة المزامنة للموقع - سيتم تحديث الأسعار تلقائياً', 'success');
        
        console.log('تم إرسال إشارة المزامنة للموقع');
        
      } catch (error) {
        console.error('خطأ في المزامنة:', error);
        showNotification('حدث خطأ في المزامنة', 'danger');
      }
    }

    // Handle Enter key in password input
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && document.getElementById('passwordInput') === document.activeElement) {
        login();
      }
    });
    
    // Add CSS animations for notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      .order-card {
        transition: all 0.3s ease;
        border-left: 4px solid #ffbe33;
      }
      
      .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      .notification-toast {
        animation: slideInRight 0.3s ease-out;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      }
      
      .notification-toast.hide {
        animation: slideOutRight 0.3s ease-in;
      }
      
      .new-order-highlight {
        border-left: 5px solid #28a745 !important;
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.1), transparent) !important;
      }
      
      .status-pending { border-left-color: #ffc107; }
      .status-confirmed { border-left-color: #17a2b8; }
      .status-delivered { border-left-color: #28a745; }
      .status-cancelled { border-left-color: #dc3545; }
    `;
    document.head.appendChild(style);

    // === إدارة المنيو من الداتابيز ===
    
    async function loadMenuFromDatabase() {
      try {
        const response = await apiService.getMenu();
        if (response.success && response.data) {
          displayMenuItems(response.data);
          console.log('✅ تم تحميل المنيو من الداتابيز');
        }
      } catch (error) {
        console.error('❌ خطأ في تحميل المنيو:', error);
        showNotification('فشل في تحميل المنيو من الداتابيز', 'danger');
      }
    }
    
    function displayMenuItems(menuItems) {
      const menuContainer = document.getElementById('menuItemsContainer');
      if (!menuContainer) {
        // إنشاء container للمنيو إذا لم يكن موجود
        const newContainer = document.createElement('div');
        newContainer.id = 'menuItemsContainer';
        newContainer.innerHTML = `
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-utensils"></i> إدارة المنيو</h5>
              <button class="btn btn-success btn-sm" onclick="addNewMenuItem()">
                <i class="fas fa-plus"></i> إضافة صنف جديد
              </button>
            </div>
            <div class="card-body" id="menuItemsList"></div>
          </div>
        `;
        
        // إضافة المنيو بعد قسم الطلبات
        const ordersSection = document.querySelector('.orders-section');
        if (ordersSection) {
          ordersSection.parentNode.insertBefore(newContainer, ordersSection.nextSibling);
        }
      }
      
      const menuList = document.getElementById('menuItemsList');
      menuList.innerHTML = '';
      
      menuItems.forEach(item => {
        const itemCard = document.createElement('div');
        itemCard.className = 'menu-item-card mb-3 p-3 border rounded';
        itemCard.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-3">
              <img src="${item.image}" alt="${item.name}" class="img-fluid rounded" style="max-height: 80px;">
            </div>
            <div class="col-md-4">
              <h6 class="mb-1">${item.name}</h6>
              <small class="text-muted">${item.category}</small>
              <p class="mb-0 small">${item.description}</p>
            </div>
            <div class="col-md-2">
              <div class="input-group input-group-sm">
                <input type="number" class="form-control" value="${item.price}" 
                       id="price-${item._id}" min="0" step="5">
                <div class="input-group-append">
                  <span class="input-group-text">ج</span>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary btn-sm me-2" onclick="updateItemPrice('${item._id}')">
                <i class="fas fa-save"></i> حفظ
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${item._id}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </div>
          </div>
        `;
        menuList.appendChild(itemCard);
      });
    }
    
    async function updateItemPrice(itemId) {
      const priceInput = document.getElementById(`price-${itemId}`);
      const newPrice = parseFloat(priceInput.value);
      
      if (isNaN(newPrice) || newPrice < 0) {
        showNotification('السعر غير صحيح', 'danger');
        return;
      }
      
      try {
        const response = await apiService.updateMenuItem(itemId, { price: newPrice });
        if (response.success) {
          showNotification(`تم تحديث السعر إلى ${newPrice} ج`, 'success');
          console.log('✅ تم تحديث السعر في الداتابيز');
        }
      } catch (error) {
        console.error('❌ خطأ في تحديث السعر:', error);
        showNotification('فشل في تحديث السعر', 'danger');
      }
    }
    
    async function deleteMenuItem(itemId) {
      if (!confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
        return;
      }
      
      try {
        const response = await apiService.deleteMenuItem(itemId);
        if (response.success) {
          showNotification('تم حذف العنصر بنجاح', 'success');
          loadMenuFromDatabase(); // إعادة تحميل القائمة
        }
      } catch (error) {
        console.error('❌ خطأ في حذف العنصر:', error);
        showNotification('فشل في حذف العنصر', 'danger');
      }
    }
    
    // تحميل المنيو عند تسجيل الدخول
    const originalLogin = window.login;
    window.login = function() {
      const result = originalLogin();
      if (result !== false) {
        setTimeout(() => {
          loadMenuFromDatabase();
        }, 1000);
      }
      return result;
    };
    
  </script>
</body>
</html>